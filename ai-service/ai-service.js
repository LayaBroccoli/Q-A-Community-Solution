const OpenAI = require('openai');

class AIService {
  constructor() {
    this.client = new OpenAI({
      apiKey: process.env.OPENAI_API_KEY,
      baseURL: process.env.OPENAI_BASE_URL || 'https://api.openai.com/v1'
    });
    this.model = process.env.OPENAI_MODEL || 'gpt-4';
  }

  /**
   * ç‰ˆæœ¬æ£€æµ‹å‡½æ•°ï¼ˆv4.0 è§„èŒƒï¼‰
   */
  detectVersion(title, content) {
    const text = (title + ' ' + content).toLowerCase();

    // 3.x å¼ºä¿¡å·ï¼ˆæƒé‡ 10ï¼‰
    const v3Strong = ['layaair3', 'layaair 3', 'laya3', '3.x', '3.0', '3.1', '3.2', '3.3', '3.4', 'ide 3', 'ide3'];
    // 3.x å¼±ä¿¡å·ï¼ˆæƒé‡ 3ï¼‰
    const v3WeakPatterns = [
      /import\s+.*?\s+from\s+["']laya/i,
      /@regclass/i
    ];
    // 2.x å¼ºä¿¡å·ï¼ˆæƒé‡ 10ï¼‰
    const v2Strong = ['layaair2', 'layaair 2', 'laya2', '2.x', '2.0', '2.13', 'ldc2', 'ide 2', 'ide2'];
    // 2.x å¼±ä¿¡å·ï¼ˆæƒé‡ 3ï¼‰
    const v2WeakPatterns = [
      /laya\.init\s*\(/i,
      /laya\.stage\./i,
      /laya\.display\.sprite/i,
      /laya\.handler\.create/i
    ];

    let v3Score = 0;
    let v2Score = 0;

    // è®¡ç®— 3.x åˆ†æ•°
    for (const kw of v3Strong) {
      if (text.includes(kw)) v3Score += 10;
    }
    for (const pattern of v3WeakPatterns) {
      if (pattern.test(text)) v3Score += 3;
    }

    // è®¡ç®— 2.x åˆ†æ•°
    for (const kw of v2Strong) {
      if (text.includes(kw)) v2Score += 10;
    }
    for (const pattern of v2WeakPatterns) {
      if (pattern.test(text)) v2Score += 3;
    }

    if (v3Score > v2Score) return '3.x';
    if (v2Score > v3Score) return '2.x';
    return '3.x (é»˜è®¤)';
  }

  /**
   * System Prompt v4.0ï¼ˆä¸¥æ ¼æŒ‰ç…§è§„èŒƒç¬¬åèŠ‚ï¼‰
   */
  getSystemPrompt() {
    return `ä½ æ˜¯ LayaAir ç¤¾åŒºçš„æŠ€æœ¯æ”¯æŒåŠ©æ‰‹ã€‚ä½ çš„å›ç­”å¿…é¡»åŸºäºã€å‚è€ƒèµ„æ–™ã€‘ä¸­æä¾›çš„å†…å®¹ã€‚

## å¸–å­ç±»å‹åˆ¤æ–­ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼Œå…ˆåˆ†ç±»å†å›å¤ï¼‰

æ”¶åˆ°å¸–å­åï¼Œå…ˆåˆ¤æ–­ç±»å‹ï¼Œé€‰æ‹©å¯¹åº”çš„å›å¤ç­–ç•¥ï¼š

### éæŠ€æœ¯å¸–ï¼ˆæ‹›è˜/å¤–åŒ…/é—²èŠ/å¹¿å‘Šï¼‰ â†’ ç­–ç•¥Aï¼šæç®€å‹å¥½å›å¤
1~2æ®µè¯ï¼Œå‹å¥½å›åº”ï¼Œä¸ç»™æŠ€æœ¯å›ç­”ï¼Œå»ºè®®å‘åˆ°åˆé€‚æ¿å—ã€‚50~150å­—ç¬¦ã€‚

### åŠŸèƒ½å»ºè®®ï¼ˆ"å¸Œæœ›æ”¯æŒ""å»ºè®®å¢åŠ ""èƒ½ä¸èƒ½åŠ "ï¼‰ â†’ ç­–ç•¥Bï¼šç®€çŸ­å…±é¸£å›å¤
1. ä¸€å¥è¯è®¤åŒéœ€æ±‚
2. åŸºäºå‚è€ƒèµ„æ–™è¯´æ˜ç°çŠ¶ï¼›å‚è€ƒèµ„æ–™ä¸­æ²¡æœ‰ç›¸å…³ä¿¡æ¯æ—¶ï¼Œè¯´"ç›®å‰æš‚æœªäº†è§£åˆ°ç›¸å…³æ”¯æŒä¿¡æ¯"ï¼Œä¸ç¼–é€ åŠŸèƒ½çŠ¶æ€
3. å»ºè®®åˆ°ç¤¾åŒºåé¦ˆåŒºæäº¤å»ºè®®æˆ–å…³æ³¨ç‰ˆæœ¬æ›´æ–°
4. å¯é™„ä¸´æ—¶æ›¿ä»£æ–¹æ¡ˆ
â†’ 150~400å­—ç¬¦ï¼Œä¸ç”¨æ ‡å‡†5æ®µç»“æ„

### ç”¨æˆ·å·²è‡ªè¡Œè§£å†³ï¼ˆ"æå®šäº†""æˆ‘æé”™äº†""å·²è§£å†³"ï¼‰ â†’ ç­–ç•¥Cï¼šç®€çŸ­ç¡®è®¤å›å¤
ç®€çŸ­ç¡®è®¤+å¯è¡¥å……ä¸€ç‚¹ç›¸å…³çŸ¥è¯†ã€‚100~300å­—ç¬¦ã€‚

### æç®€å¸–å­ï¼ˆæ ‡é¢˜<5å­—ï¼Œæ­£æ–‡ä¸ºç©ºï¼‰ â†’ ç­–ç•¥Dï¼šå¼•å¯¼è¡¥å……å›å¤
åŸºäºæ ‡é¢˜å…³é”®è¯ç»™é€šç”¨å¼•å¯¼+å»ºè®®è¡¥å……å…·ä½“é—®é¢˜ã€‚100~300å­—ç¬¦ã€‚

### å¤šé—®é¢˜å¸–å­ï¼ˆæ­£æ–‡å«â‰¥3ä¸ªç‹¬ç«‹é—®é¢˜ï¼‰ â†’ ç­–ç•¥Eï¼šåˆ†æ¡å›ç­”
æŒ‰é—®é¢˜åˆ†æ¡å›ç­”ï¼Œæ¯ä¸ªé—®é¢˜è‡³å°‘ç»™æ–¹å‘ã€‚800~1500å­—ç¬¦ã€‚

### æŠ€æœ¯é—®é¢˜ï¼ˆä»¥ä¸Šéƒ½ä¸æ˜¯ï¼‰ â†’ ç­–ç•¥Fï¼šæ ‡å‡†æŠ€æœ¯å›å¤
ä½¿ç”¨ä¸‹æ–¹æ ‡å‡†å›å¤ç»“æ„ã€‚

---

## çŸ¥è¯†æ¥æºè§„åˆ™ï¼ˆä¸¥æ ¼æ‰§è¡Œï¼‰

### 1. å½“ã€å‚è€ƒèµ„æ–™ã€‘åŒ…å«ç›¸å…³APIã€ä»£ç æˆ–æ–‡æ¡£æ—¶
- åŸºäºå‚è€ƒèµ„æ–™å›ç­”
- ä»£ç ä¸­åªä½¿ç”¨å‚è€ƒèµ„æ–™ä¸­å‡ºç°è¿‡çš„APIå’Œç±»å
- æ–‡æ¡£é“¾æ¥ä½¿ç”¨å‚è€ƒèµ„æ–™ä¸­æä¾›çš„é“¾æ¥

### 2. å½“ã€å‚è€ƒèµ„æ–™ã€‘ä¸ºç©ºæˆ–ä¸ç›¸å…³æ—¶
- å¯åŸºäºé€šç”¨ç¼–ç¨‹çŸ¥è¯†ç»™å‡ºæ–¹å‘æ€§å»ºè®®
- **ä¸å¾—ç¼–é€ ä»»ä½•LayaAirç‰¹æœ‰çš„APIåç§°ã€ç±»åã€æ–¹æ³•å**
- **ä¸å¾—ç¼–é€ æ–‡æ¡£URL**
- **ä¸å¾—ç¼–é€ åŠŸèƒ½æ”¯æŒçŠ¶æ€**ï¼ˆä¸èƒ½è¯´"æ ¹æ®å®˜æ–¹æ–‡æ¡£ï¼Œç›®å‰æ¶µç›–äº†XXåŠŸèƒ½ä½†æš‚æœªæåŠYY"ï¼Œé™¤éå‚è€ƒèµ„æ–™ç¡®å®æœ‰è¿™äº›ä¿¡æ¯ï¼‰
- å¿…é¡»è¯´æ˜"å»ºè®®æŸ¥é˜…å®˜æ–¹æ–‡æ¡£è·å–è¯¦ç»†ç”¨æ³•"å¹¶ç»™å‡ºæ–‡æ¡£å…¥å£é“¾æ¥

### 3. ç»å¯¹ç¦æ­¢
- ç¼–é€ ä¸å­˜åœ¨çš„API
- ç¼–é€ æ–‡æ¡£URLè·¯å¾„
- ç¼–é€ åŠŸèƒ½ç°çŠ¶æè¿°
- å£°ç§°"ä»¥ä¸‹ä»£ç å¯ç›´æ¥è¿è¡Œ"ä½†ä½¿ç”¨äº†æœªç»å‚è€ƒèµ„æ–™éªŒè¯çš„API

---

## ç‰ˆæœ¬è¯†åˆ«è§„åˆ™

æ ¹æ®ç”¨æˆ·å¸–å­å†…å®¹åˆ¤æ–­LayaAirç‰ˆæœ¬ï¼š

**3.xä¿¡å·**ï¼šLayaAir3ã€3.xã€3.0~3.4ã€import...from "laya/"ã€@regClass()ã€IDE 3.x
**2.xä¿¡å·**ï¼šLayaAir2ã€2.xã€Laya.init()ã€laya.display.Spriteã€Laya.Handler.createã€ldc2
**æ— æ³•åˆ¤æ–­æ—¶**ï¼šé»˜è®¤æŒ‰3.xå›ç­”ï¼Œå¹¶åœ¨å›å¤å¼€å¤´æ³¨æ˜"ä»¥ä¸‹åŸºäºLayaAir 3.xï¼Œå¦‚ä½ ä½¿ç”¨2.xè¯·è¯´æ˜"ã€‚

---

## é“¾æ¥è§„åˆ™

1. å‚è€ƒèµ„æ–™ä¸­æœ‰æ–‡æ¡£é“¾æ¥ â†’ ç›´æ¥ä½¿ç”¨
2. å‚è€ƒèµ„æ–™ä¸­æ— é“¾æ¥ â†’ åªæä¾›å…¥å£é“¾æ¥ï¼š
   - 3.xæ–‡æ¡£ï¼šhttps://layaair.com/3.x/doc/
   - 3.x APIï¼šhttps://layaair.com/3.x/api/
   - 2.xæ–‡æ¡£ï¼šhttps://ldc2.layabox.com/doc/
   - ç¤¾åŒºè®ºå›ï¼šhttps://ask.layabox.com/
3. **ç»å¯¹ä¸è‡ªè¡Œæ‹¼æ¥å…·ä½“çš„æ–‡æ¡£é¡µé¢è·¯å¾„**

---

## æ ‡å‡†å›å¤ç»“æ„ï¼ˆä»…ç”¨äºæŠ€æœ¯é—®é¢˜ï¼‰

### 1. é—®é¢˜åˆ†æï¼ˆ30~100å­—ï¼‰
ä¸€å¥è¯æ¦‚æ‹¬é—®é¢˜ï¼Œæ ‡æ³¨ç‰ˆæœ¬å’Œæ¶‰åŠæ¨¡å—ã€‚

### 2. è§£å†³æ–¹æ¡ˆ
åˆ†æ­¥éª¤è¯´æ˜ï¼Œä½¿ç”¨æœ‰åºåˆ—è¡¨ã€‚
å¤šæ–¹æ¡ˆæ—¶ç”¨äºŒçº§æ ‡é¢˜"### æ–¹æ¡ˆä¸€/äºŒ"åŒºåˆ†ã€‚

### 3. ä»£ç ç¤ºä¾‹ï¼ˆæœ‰å‚è€ƒèµ„æ–™æ—¶å¿…é¡»æä¾›ï¼‰
\`\`\`typescript
// TypeScriptä»£ç ï¼Œåªç”¨å‚è€ƒèµ„æ–™ä¸­å‡ºç°çš„API
// å¼•æ“ç±»åŠ Laya.å‰ç¼€
\`\`\`

### 4. å‚è€ƒæ–‡æ¡£ï¼ˆå¿…é¡»ï¼‰
ä¼˜å…ˆç”¨å‚è€ƒèµ„æ–™ä¸­çš„é“¾æ¥ï¼›
æ— å…·ä½“é“¾æ¥æ—¶ç”¨å…¥å£é“¾æ¥ã€‚

### 5. æ³¨æ„äº‹é¡¹ï¼ˆå¯é€‰ï¼‰
å¸¸è§é™·é˜±ã€æœ€ä½³å®è·µã€ç‰ˆæœ¬å·®å¼‚ã€‚

---

## é•¿åº¦æ ‡å‡†

| é—®é¢˜å¤æ‚åº¦ | é•¿åº¦ | å…¸å‹åœºæ™¯ |
|-----------|------|----------|
| ç®€å• | 200~500å­—ç¬¦ | å•ä¸€APIç”¨æ³•ã€æ¦‚å¿µè§£é‡Š |
| ä¸­ç­‰ | 500~1000å­—ç¬¦ | å¤šæ­¥éª¤æ“ä½œã€å«ä»£ç ç¤ºä¾‹ |
| å¤æ‚ | 800~1500å­—ç¬¦ | å¤šåŸå› æ’æŸ¥ã€è·¨æ¨¡å—é—®é¢˜ |

ä¸ç¡¬å‡‘å­—æ•°ï¼Œä¸Šé™2000å­—ç¬¦ã€‚

---

## ä»£ç è§„èŒƒ

- è¯­è¨€ï¼šTypeScript
- å¼•æ“ç±»å…¨éƒ¨åŠ \`Laya.\`å‰ç¼€ï¼š\`Laya.Sprite\`ã€\`Laya.Handler.create(...)\`
- **æœ‰MCPç»“æœ**ï¼šåªä½¿ç”¨å‚è€ƒèµ„æ–™ä¸­å‡ºç°è¿‡çš„APIï¼Œå¿…é¡»æä¾›ä»£ç 
- **æ— MCPç»“æœ**ï¼šåªå†™é€šç”¨TypeScripté€»è¾‘æ¡†æ¶ï¼Œæ³¨é‡Šæ ‡æ³¨"è¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£å¡«å…¥å…·ä½“API"ï¼Œ**ä¸ç¼–é€ LayaAirç‰¹æœ‰API**
- èµ„æºè·¯å¾„æ ¼å¼ï¼š\`resources/å­ç›®å½•/æ–‡ä»¶å.ext\`ï¼Œç¦æ­¢UUID

---

## äººæ€§åŒ–å†™ä½œè§„åˆ™

**è¦åšçš„**ï¼š
- å¼€å¤´ç›´æ¥åˆ‡å…¥é—®é¢˜ï¼Œä¸è¯´"æ‚¨å¥½ï¼Œæˆ‘æ˜¯AIåŠ©æ‰‹"
- é‡åˆ°æ˜æ˜¾bugæ—¶ï¼Œå…ˆè¡¨ç¤ºç†è§£ï¼ˆ"è¿™ä¸ªé—®é¢˜ç¡®å®å®¹æ˜“è¸©å‘"ï¼‰å†ç»™è§£æ³•
- ä»£ç ç»™å®Œåç”¨ä¸€å¥è¯è¯´æ˜å…³é”®ç‚¹
- ä¸ç¡®å®šæ—¶è¯´"å»ºè®®æ ¸å¯¹å®˜æ–¹æ–‡æ¡£ï¼Œä»¥ä¸‹æ˜¯å¤§æ–¹å‘"ï¼Œä¸è¯´"æˆ‘ä¸çŸ¥é“"

**ä¸è¦åšçš„**ï¼š
- ä¸ç”¨"æ‚¨"ï¼ˆå¤ªæ­£å¼ï¼‰ï¼Œç”¨"ä½ "
- ä¸è¯´"å¸Œæœ›å¯¹ä½ æœ‰å¸®åŠ©"ã€"å¦‚æœ‰ç–‘é—®æ¬¢è¿ç»§ç»­æé—®"ï¼ˆåºŸè¯ï¼‰
- ä¸ç”¨emojiï¼ˆè®ºå›æŠ€æœ¯å¸–é£æ ¼ï¼‰
- ä¸è¯´"è¿™æ˜¯ä¸€ä¸ªåŸºç¡€é—®é¢˜"ï¼ˆè®©äººå°´å°¬ï¼‰
- ä¸ä¸­é€”æˆªæ–­ï¼Œä¸è¯´"ä»¥ä¸‹çœç•¥"

---

## åŠŸèƒ½æš‚ä¸æ”¯æŒç±»é—®é¢˜

å½“ç”¨æˆ·è¯¢é—®çš„åŠŸèƒ½å¼•æ“å½“å‰ä¸æ”¯æŒæ—¶ï¼š
1. æ˜ç¡®è¯´æ˜å½“å‰çŠ¶æ€
2. ç»™å‡ºå¯è¡Œçš„æ›¿ä»£æ–¹æ¡ˆæˆ–å˜é€šæ€è·¯
3. **ä¸åªè¯´"ä¸æ”¯æŒ"å°±ç»“æŸ**ï¼Œè¦æä¾›æœ‰ä»·å€¼çš„æ–¹å‘
4. å¦‚æœ‰å‚è€ƒèµ„æ–™ä¸­çš„ç›¸å…³APIï¼Œç»™å‡ºä»£ç ç¤ºä¾‹
5. å»ºè®®å…³æ³¨åç»­ç‰ˆæœ¬æ›´æ–°

---

## æ’æŸ¥ç±»é—®é¢˜ï¼ˆé»‘å±/æŠ¥é”™/ä¸æ˜¾ç¤ºï¼‰

æŒ‰ä¼˜å…ˆçº§åˆ—å‡ºå¸¸è§åŸå› ï¼Œæ¯ä¸ªåŸå› é™„æ£€æŸ¥æ–¹å¼ï¼Œæœ€åæä¾›è°ƒè¯•ä»£ç ã€‚

---

## å‘å¸ƒå‰è‡ªæ£€

- [ ] æ²¡æœ‰ç¼–é€ MCPæœªå‡ºç°çš„LayaAir APIåç§°
- [ ] æ²¡æœ‰è‡ªè¡Œæ‹¼æ¥æ–‡æ¡£é“¾æ¥
- [ ] ä»£ç å—å·²é—­åˆï¼Œæ— æˆªæ–­
- [ ] ç‰ˆæœ¬æ ‡æ³¨æ­£ç¡®
- [ ] å›å¤å®Œæ•´ï¼Œæ²¡æœ‰"æœªå®Œå¾…ç»­"

---

*v4.0 Â· 2026-02-28 Â· ä¸¥æ ¼æŒ‰ç…§æ­¤è§„èŒƒæ‰§è¡Œ*`;
  }

  /**
   * User Prompt v4.0ï¼ˆæ¨¡æ¿Aå’Œæ¨¡æ¿Bï¼‰
   */
  buildPrompt(question, mcpContext = '', detectedVersion = '3.x (é»˜è®¤)', postType = 'æŠ€æœ¯é—®é¢˜') {
    const hasMcp = mcpContext && mcpContext.trim().length > 0;

    // æ ¹æ®æ£€æµ‹ç‰ˆæœ¬ç¡®å®šå…¥å£é“¾æ¥
    let docEntryLink = 'https://layaair.com/3.x/doc/';
    let apiEntryLink = 'https://layaair.com/3.x/api/';

    if (detectedVersion === '2.x') {
      docEntryLink = 'https://ldc2.layabox.com/doc/';
      apiEntryLink = 'https://layaair2.ldc2.layabox.com/api2/';
    }

    // å¤„ç†tagsä¿¡æ¯
    const tagsInfo = question.tags && question.tags.length > 0
      ? `**æ ‡ç­¾**ï¼š${question.tags.join(', ')}\n`
      : '';

    // æ ¹æ®å¸–å­ç±»å‹é€‰æ‹©ä¸åŒçš„promptå¼€å¤´
    let typeInstruction = '';
    switch (postType) {
      case 'éæŠ€æœ¯å¸–':
        typeInstruction = '**å¸–å­ç±»å‹**ï¼šéæŠ€æœ¯å¸–ï¼ˆæ‹›è˜/å¤–åŒ…/é—²èŠï¼‰\n**å›å¤ç­–ç•¥**ï¼šæç®€å‹å¥½å›å¤ï¼Œä¸ç»™æŠ€æœ¯å›ç­”ï¼Œ50~150å­—ç¬¦ã€‚\n';
        break;
      case 'åŠŸèƒ½å»ºè®®':
        typeInstruction = '**å¸–å­ç±»å‹**ï¼šåŠŸèƒ½å»ºè®®\n**å›å¤ç­–ç•¥**ï¼šç®€çŸ­å…±é¸£å›å¤ï¼Œä¸å¥—ç”¨æ ‡å‡†5æ®µç»“æ„ï¼Œ150~400å­—ç¬¦ã€‚\n';
        break;
      case 'ç”¨æˆ·å·²è§£å†³':
        typeInstruction = '**å¸–å­ç±»å‹**ï¼šç”¨æˆ·å·²è‡ªè¡Œè§£å†³\n**å›å¤ç­–ç•¥**ï¼šç®€çŸ­ç¡®è®¤å›å¤ï¼Œ100~300å­—ç¬¦ã€‚\n';
        break;
      case 'æç®€å¸–å­':
        typeInstruction = '**å¸–å­ç±»å‹**ï¼šæç®€å¸–å­ï¼ˆå†…å®¹è¿‡å°‘ï¼‰\n**å›å¤ç­–ç•¥**ï¼šå¼•å¯¼è¡¥å……å›å¤ï¼Œ100~300å­—ç¬¦ã€‚\n';
        break;
      case 'å¤šé—®é¢˜å¸–å­':
        typeInstruction = '**å¸–å­ç±»å‹**ï¼šå¤šé—®é¢˜å¸–å­\n**å›å¤ç­–ç•¥**ï¼šåˆ†æ¡å›ç­”ï¼Œ800~1500å­—ç¬¦ã€‚\n';
        break;
      default:
        typeInstruction = '**å¸–å­ç±»å‹**ï¼šæŠ€æœ¯é—®é¢˜\n**å›å¤ç­–ç•¥**ï¼šæ ‡å‡†æŠ€æœ¯å›å¤ï¼ˆé—®é¢˜åˆ†æâ†’è§£å†³æ–¹æ¡ˆâ†’ä»£ç ç¤ºä¾‹â†’å‚è€ƒæ–‡æ¡£â†’æ³¨æ„äº‹é¡¹ï¼‰\n';
    }

    if (hasMcp) {
      // æ¨¡æ¿Aï¼šæœ‰MCPæ£€ç´¢ç»“æœ
      return `## ç”¨æˆ·é—®é¢˜

**æ ‡é¢˜**ï¼š${question.title}
**å†…å®¹**ï¼š${question.content}
${tagsInfo}**æé—®è€…**ï¼š${question.username}
**ç‰ˆæœ¬**ï¼š${detectedVersion}

${typeInstruction}

## å‚è€ƒèµ„æ–™ï¼ˆæ¥è‡ªLayaAirå®˜æ–¹çŸ¥è¯†åº“ï¼‰

${mcpContext}

## å›å¤è¦æ±‚ï¼ˆä¸¥æ ¼æ‰§è¡Œï¼‰

1. âœ… å…ˆåˆ¤æ–­å¸–å­ç±»å‹ï¼ˆå·²åœ¨ä¸Šæ–¹æ ‡æ³¨ï¼‰ï¼Œä½¿ç”¨å¯¹åº”çš„å›å¤ç­–ç•¥
2. âœ… æŠ€æœ¯é—®é¢˜ï¼šåŸºäºä¸Šæ–¹ã€å‚è€ƒèµ„æ–™ã€‘å›ç­”ï¼Œä»£ç åªä½¿ç”¨å‚è€ƒèµ„æ–™ä¸­å‡ºç°çš„API
3. âœ… åŠŸèƒ½å»ºè®®/éæŠ€æœ¯å¸–/å·²è§£å†³/æç®€å¸–å­ï¼šæŒ‰ç…§å¯¹åº”çš„ç­–ç•¥å›å¤ï¼Œä¸å¥—ç”¨æ ‡å‡†æŠ€æœ¯å›å¤ç»“æ„
4. âœ… æ–‡æ¡£é“¾æ¥ä¼˜å…ˆä½¿ç”¨å‚è€ƒèµ„æ–™ä¸­æä¾›çš„é“¾æ¥
5. âœ… å‚è€ƒèµ„æ–™ä¸è¶³æ—¶ï¼Œæ˜ç¡®æŒ‡å‡ºå“ªäº›éƒ¨åˆ†éœ€æŸ¥é˜…å®˜æ–¹æ–‡æ¡£
6. âœ… æŒ‰ç…§ç³»ç»ŸæŒ‡ä»¤ä¸­çš„å¯¹åº”å›å¤ç»“æ„è¾“å‡º

è¯·å›ç­”ï¼š`;
    } else {
      // æ¨¡æ¿Bï¼šæ— MCPæ£€ç´¢ç»“æœ
      return `## ç”¨æˆ·é—®é¢˜

**æ ‡é¢˜**ï¼š${question.title}
**å†…å®¹**ï¼š${question.content}
${tagsInfo}**æé—®è€…**ï¼š${question.username}
**ç‰ˆæœ¬**ï¼š${detectedVersion}

${typeInstruction}

## å‚è€ƒèµ„æ–™

æœªæ£€ç´¢åˆ°ä¸æ­¤é—®é¢˜ç›´æ¥ç›¸å…³çš„å®˜æ–¹æ–‡æ¡£å†…å®¹ã€‚

## å›å¤è¦æ±‚ï¼ˆä¸¥æ ¼æ‰§è¡Œï¼‰

1. âœ… å…ˆåˆ¤æ–­å¸–å­ç±»å‹ï¼ˆå·²åœ¨ä¸Šæ–¹æ ‡æ³¨ï¼‰ï¼Œä½¿ç”¨å¯¹åº”çš„å›å¤ç­–ç•¥
2. âœ… æŠ€æœ¯é—®é¢˜ï¼šåŸºäºé€šç”¨ç¼–ç¨‹çŸ¥è¯†ç»™å‡ºæ–¹å‘æ€§å»ºè®®ï¼Œ**ä¸ç¼–é€ LayaAirç‰¹æœ‰API**
3. âœ… åŠŸèƒ½å»ºè®®ï¼šä¸ç¼–é€ åŠŸèƒ½æ”¯æŒçŠ¶æ€ï¼Œè¯´"ç›®å‰æš‚æœªäº†è§£åˆ°ç›¸å…³æ”¯æŒä¿¡æ¯"
4. âœ… ä»£ç ç¤ºä¾‹ä»…åŒ…å«é€šç”¨TypeScripté€»è¾‘ï¼Œä¸å†™æœªç»éªŒè¯çš„LayaAir APIè°ƒç”¨
5. âœ… ç›¸å…³æ–‡æ¡£åªæä¾›å…¥å£é“¾æ¥ï¼š
   - 3.xæ–‡æ¡£ï¼š${docEntryLink}
   - 3.x APIï¼š${apiEntryLink}
   - 2.xæ–‡æ¡£ï¼š${docEntryLink}
   - ç¤¾åŒºè®ºå›ï¼šhttps://ask.layabox.com/
6. âœ… æŒ‰ç…§ç³»ç»ŸæŒ‡ä»¤ä¸­çš„å¯¹åº”å›å¤ç»“æ„è¾“å‡º

è¯·å›ç­”ï¼š`;
    }
  }

  /**
   * ç”ŸæˆAIå›ç­”ï¼ˆv4.0ï¼‰
   */
  async generateAnswer(question, mcpContext = '', postType = 'æŠ€æœ¯é—®é¢˜') {
    try {
      console.log(`\nğŸ¤– ç”ŸæˆAIå›ç­”...`);
      console.log(`   é—®é¢˜: ${question.title}`);
      console.log(`   æ¨¡å‹: ${this.model}`);

      // ç‰ˆæœ¬æ£€æµ‹
      const detectedVersion = this.detectVersion(question.title, question.content);
      console.log(`   ç‰ˆæœ¬: ${detectedVersion}`);

      const prompt = this.buildPrompt(question, mcpContext, detectedVersion, postType);

      const completion = await this.client.chat.completions.create({
        model: this.model,
        messages: [
          {
            role: 'system',
            content: this.getSystemPrompt()
          },
          {
            role: 'user',
            content: prompt
          }
        ],
        temperature: 0.7,
        max_tokens: 4000,
        timeout: 240000,
        extra_body: {
          enable_thinking: false
        }
      });

      const choice = completion.choices[0];
      const message = choice.message;

      // ä¼˜å…ˆä½¿ç”¨contentå­—æ®µ
      let answer = message.content || '';

      // å¦‚æœcontentä¸ºç©ºï¼Œè¯»å–reasoning_contentï¼ˆGLM-4.7æ€ç»´é“¾æ¨¡å¼ï¼‰
      if ((!answer || answer.trim().length === 0) && message.reasoning_content) {
        const reasoning = message.reasoning_content;

        // æå–ç­”æ¡ˆéƒ¨åˆ†ï¼ˆè¿‡æ»¤æ€è€ƒè¿‡ç¨‹ï¼Œåªä¿ç•™æœ€ç»ˆç­”æ¡ˆï¼‰
        const answerStart = reasoning.indexOf('## é—®é¢˜åˆ†æ') !== -1
          ? reasoning.indexOf('## é—®é¢˜åˆ†æ')
          : reasoning.indexOf('### é—®é¢˜åˆ†æ') !== -1
          ? reasoning.indexOf('### é—®é¢˜åˆ†æ')
          : reasoning.indexOf('## é—®é¢˜') !== -1
          ? reasoning.indexOf('## é—®é¢˜')
          : -1;

        if (answerStart !== -1) {
          answer = reasoning.substring(answerStart);
          console.log(`   âœ… ä»reasoning_contentæå–ç­”æ¡ˆ (${answer.length}å­—ç¬¦)`);
        } else {
          console.warn(`   âš ï¸  reasoning_contentä¸­æœªæ‰¾åˆ°ç­”æ¡ˆæ ‡è®°`);
          return {
            success: false,
            error: 'No answer in reasoning_content',
            answer: this.getFallbackAnswer(question)
          };
        }
      }

      if (!answer || answer.trim().length === 0) {
        console.warn(`   âš ï¸  AIè¿”å›ç©ºç­”æ¡ˆï¼Œä½¿ç”¨å¤‡ç”¨ç­”æ¡ˆ`);
        return {
          success: false,
          error: 'Empty answer',
          answer: this.getFallbackAnswer(question)
        };
      }

      console.log(`   âœ… ç­”æ¡ˆç”ŸæˆæˆåŠŸ (${answer.length}å­—ç¬¦)`);

      return {
        success: true,
        answer: answer
      };

    } catch (error) {
      console.error(`   âŒ ç”Ÿæˆå¤±è´¥: ${error.message}`);
      return {
        success: false,
        error: error.message,
        answer: this.getFallbackAnswer(question)
      };
    }
  }

  /**
   * å¤‡ç”¨ç­”æ¡ˆï¼ˆå½“AIç”Ÿæˆå¤±è´¥æ—¶ä½¿ç”¨ï¼‰
   */
  getFallbackAnswer(question) {
    return `## é—®é¢˜åˆ†æ

è¿™ä¸ªé—®é¢˜æ¶‰åŠåˆ°LayaAirå¼•æ“çš„ä½¿ç”¨ã€‚

## è§£å†³æ–¹æ¡ˆ

å»ºè®®æŸ¥é˜…å®˜æ–¹æ–‡æ¡£è·å–è¯¦ç»†ä¿¡æ¯å’Œè§£å†³æ–¹æ¡ˆã€‚

## å‚è€ƒæ–‡æ¡£

- [LayaAir 3.x æ–‡æ¡£](https://layaair.com/3.x/doc/)
- [LayaAir 3.x API](https://layaair.com/3.x/api/)
- [ç¤¾åŒºè®ºå›](https://ask.layabox.com/)

å¦‚æœä»¥ä¸Šé“¾æ¥æ— æ³•è§£å†³ä½ çš„é—®é¢˜ï¼Œå»ºè®®åœ¨ç¤¾åŒºå‘å¸–æ—¶é™„ä¸Šå®Œæ•´ä»£ç å’ŒæŠ¥é”™ä¿¡æ¯ï¼Œä»¥ä¾¿è·å¾—æ›´æœ‰é’ˆå¯¹æ€§çš„å¸®åŠ©ã€‚`;
  }

  async testConnection() {
    try {
      console.log('\nğŸ§ª æµ‹è¯•AIè¿æ¥...');

      const testPrompt = `è¯·ç®€å•ä»‹ç»ä¸€ä¸‹LayaAirå¼•æ“ã€‚`;

      const completion = await this.client.chat.completions.create({
        model: this.model,
        messages: [
          { role: 'user', content: testPrompt }
        ],
        max_tokens: 500,
        timeout: 30000
      });

      const answer = completion.choices[0].message.content;
      console.log(`âœ… AIè¿æ¥æˆåŠŸ`);
      console.log(`   å›å¤: ${answer.substring(0, 100)}...`);

      return { success: true, answer };
    } catch (error) {
      console.error(`âŒ AIè¿æ¥å¤±è´¥: ${error.message}`);
      return { success: false, error: error.message };
    }
  }
}

module.exports = AIService;
