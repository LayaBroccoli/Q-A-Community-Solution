ğŸ‰ **AIè¯„åˆ†ç³»ç»Ÿ - æœ€ç»ˆç‰ˆï¼ˆæ‰€æœ‰é—®é¢˜å·²ä¿®å¤ï¼‰**

**ç‰ˆæœ¬**: v1.2 Final (2026-02-28 11:35)
**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª

=======================================
Flarumé›†æˆä»£ç 
=======================================*/

<script>
(function() {
  console.log('[AIè¯„åˆ†] å¯åŠ¨ v1.2 Final');

  const CONFIG = {
    apiBaseUrl: 'http://43.128.56.125:8080/proxy-rating',
    aiUsername: 'AIåŠ©æ‰‹'
  };

  function addRatingBox() {
    document.querySelectorAll('article.CommentPost.Post').forEach(function(post) {
      if (post.querySelector('.ai-rating-box')) return;

      const username = post.querySelector('.username');
      if (!username || username.textContent.trim() !== CONFIG.aiUsername) return;

      const container = post.closest('[data-id]');
      const postId = container?.dataset?.id;
      if (!postId) return;

      console.log('âœ… æ‰¾åˆ°AIå›å¤ï¼Œå¸–å­ID:', postId);

      const box = document.createElement('div');
      box.className = 'ai-rating-box';
      box.innerHTML =
        '<div style="margin-top:15px;padding:15px;background:#f8f9fa;border-radius:8px;border:1px solid #e0e0e0">' +
          '<div style="font-size:14px;font-weight:600;margin-bottom:10px">ğŸ“Š è¿™ä¸ªå›ç­”æœ‰å¸®åŠ©å—ï¼Ÿ</div>' +
          '<div style="display:flex;gap:8px">' +
            '<button onclick="window.submitAIRating(this,' + postId + ',\'helpful\')" style="flex:1;padding:10px;border:2px solid #ddd;border-radius:8px;background:#fff;cursor:pointer;transition:all 0.2s" onmouseover="this.style.borderColor=\'#4caf50\'" onmouseout="this.style.borderColor=\'#ddd\'">âœ… è§£å†³</button>' +
            '<button onclick="window.submitAIRating(this,' + postId + ',\'partial\')" style="flex:1;padding:10px;border:2px solid #ddd;border-radius:8px;background:#fff;cursor:pointer;transition:all 0.2s" onmouseover="this.style.borderColor=\'#ff9800\'" onmouseout="this.style.borderColor=\'#ddd\'">âš ï¸ éƒ¨åˆ†</button>' +
            '<button onclick="window.submitAIRating(this,' + postId + ',\'not_helpful\')" style="flex:1;padding:10px;border:2px solid #ddd;border-radius:8px;background:#fff;cursor:pointer;transition:all 0.2s" onmouseover="this.style.borderColor=\'#f44336\'" onmouseout="this.style.borderColor=\'#ddd\'">âŒ æœªè§£å†³</button>' +
            '<button onclick="window.submitAIRating(this,' + postId + ',\'irrelevant\')" style="flex:1;padding:10px;border:2px solid #ddd;border-radius:8px;background:#fff;cursor:pointer;transition:all 0.2s" onmouseover="this.style.borderColor=\'#9e9e9e\'" onmouseout="this.style.borderColor=\'#ddd\'">ğŸ¤” ä¸ç›¸å…³</button>' +
          '</div>' +
          '<div class="feedback" style="margin-top:10px;font-size:13px;color:#666;text-align:center"></div>' +
        '</div>';

      post.querySelector('.Post-body')?.appendChild(box);
      console.log('âœ… è¯„åˆ†æ¡†å·²æ·»åŠ ');
    });
  }

  window.submitAIRating = function(btn, postId, rating) {
    const box = btn.closest('.ai-rating-box') || btn.parentElement.parentElement;
    const feedback = box.querySelector('.feedback');
    const buttons = box.querySelectorAll('button');

    buttons.forEach(b => b.disabled = true);
    feedback.textContent = 'æäº¤ä¸­...';

    console.log('=== æäº¤è¯„åˆ† ===');
    console.log('å¸–å­ID:', postId);
    console.log('è¯„åˆ†ç±»å‹:', rating);

    fetch(CONFIG.apiBaseUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        post_id: parseInt(postId),
        rating: rating
      })
    })
    .then(res => res.json())
    .then(data => {
      console.log('å“åº”æ•°æ®:', data);

      if (data.success) {
        feedback.textContent = 'âœ… æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼';
        feedback.style.color = '#4caf50';
        btn.style.opacity = '0.5';
        btn.style.cursor = 'not-allowed';
      } else {
        feedback.textContent = 'âŒ ' + data.error;
        feedback.style.color = '#f44336';
        buttons.forEach(b => b.disabled = false);
      }
    })
    .catch(err => {
      console.error('é”™è¯¯:', err);
      feedback.textContent = 'âŒ ç½‘ç»œé”™è¯¯: ' + err.message;
      feedback.style.color = '#f44336';
      buttons.forEach(b => b.disabled = false);
    });
  };

  addRatingBox();
  new MutationObserver(addRatingBox).observe(document.body, { childList: true, subtree: true });

  console.log('[AIè¯„åˆ†] å¯åŠ¨å®Œæˆ v1.2 Final - æ‰€æœ‰é—®é¢˜å·²ä¿®å¤ âœ…');
})();
</script>

=======================================
å®‰è£…è¯´æ˜
=======================================*/

## ğŸ“ å¿«é€Ÿå®‰è£…ï¼ˆ2åˆ†é’Ÿï¼‰

### ç¬¬1æ­¥ï¼šæ·»åŠ CSSï¼ˆå¯é€‰ï¼‰

**Flarum Admin â†’ Appearance â†’ Custom CSS**

```css
.ai-rating-box button:hover {
  transform: translateY(-2px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1)
}
```

### ç¬¬2æ­¥ï¼šæ·»åŠ JavaScript

**Flarum Admin â†’ Appearance â†’ Custom Header**

**åˆ é™¤æ—§ä»£ç ï¼Œç²˜è´´ä¸Šé¢çš„å®Œæ•´ä»£ç **

### ç¬¬3æ­¥ï¼šä¿å­˜å¹¶åˆ·æ–°

**Save Changes** â†’ åˆ·æ–°è®ºå›é¡µé¢

---

## âœ… v1.2 ä¿®å¤å†…å®¹

### å·²è§£å†³çš„é—®é¢˜
- âœ… CORSé”™è¯¯ï¼ˆ OPTIONSé¢„æ£€è¯·æ±‚ï¼‰
- âœ… undefinedå‚æ•°é”™è¯¯ï¼ˆè½¬æ¢ä¸ºnullï¼‰
- âœ… æ•°æ®åº“çº¦æŸé”™è¯¯ï¼ˆå…è®¸discussion_idä¸ºNULLï¼‰
- âœ… 8080ç«¯å£ä»£ç†é…ç½®
- âœ… Flarum DOMé€‰æ‹©å™¨ä¿®å¤

### æœåŠ¡å™¨ç«¯ä¿®å¤
- âœ… ä»£ç†æœåŠ¡å™¨CORS headerså®Œæ•´
- âœ… æ•°æ®åº“è¡¨ç»“æ„æ›´æ–°
- âœ… å‚æ•°éªŒè¯å’Œç©ºå€¼å¤„ç†

---

## ğŸ§ª åŠŸèƒ½æµ‹è¯•

åˆ·æ–°é¡µé¢åï¼Œç‚¹å‡»è¯„åˆ†æŒ‰é’®ï¼š
1. âœ… ç«‹å³æ˜¾ç¤º"âœ… æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼"
2. âœ… æŒ‰é’®å˜ç°ï¼ˆä¸å¯é‡å¤ç‚¹å‡»ï¼‰
3. âœ… Consoleæ˜¾ç¤ºæˆåŠŸå“åº”

---

## ğŸ“Š æ•°æ®æŸ¥è¯¢

### æŸ¥çœ‹æœ€æ–°è¯„åˆ†
```sql
SELECT 
  r.id,
  r.post_id,
  r.rating_type,
  r.created_at
FROM ai_ratings r
ORDER BY r.created_at DESC
LIMIT 10;
```

### æŸ¥çœ‹ç»Ÿè®¡æŠ¥å‘Š
```sql
SELECT 
  post_id,
  total_ratings,
  helpful_count,
  partial_count,
  not_helpful_count,
  irrelevant_count,
  average_score
FROM ai_rating_stats
WHERE total_ratings > 0
ORDER BY average_score DESC;
```

---

## ğŸ”§ æœåŠ¡çŠ¶æ€

**ä¸»æœåŠ¡å™¨**ï¼ˆ3000ç«¯å£ï¼‰
```bash
ps aux | grep "node server.js" | grep -v grep
```

**ä»£ç†æœåŠ¡å™¨**ï¼ˆ8080ç«¯å£ï¼‰
```bash
ps aux | grep "proxy-server.js" | grep -v grep
```

---

**ğŸ‰ ç”Ÿäº§å°±ç»ªï¼å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼**

**å¦‚æœ‰é—®é¢˜ï¼ŒæŸ¥çœ‹Consoleæ—¥å¿—è¾“å‡ºï¼** ğŸ”
