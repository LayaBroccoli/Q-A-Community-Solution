# 工作总结 - AI 自动回复系统优化

## 日期
2026-02-27

## 工作时间
约 4 小时

---

## 核心成果

### 1. 完整技术文档 ✅
- **文件**: `AUTO_REPLY_SYSTEM_DOC.md`（9KB）
- **内容**: 系统概述、技术栈、架构、部署流程、配置说明、故障排查、维护指南
- **状态**: 已通过Telegram发送

### 2. v4.0 规范升级 ✅
严格按照用户提供的 v4.0 提示词规范，完成以下升级：

#### 2.1 系统提示词更新（ai-service.js）
- 完全替换 `getSystemPrompt()` 方法
- 新增规范：
  - 预过滤规则（吐槽、招聘、灌水→跳过）
  - MCP关键词提炼（拆原子→去噪音→英文优先）
  - 工具智能选择（get_api_detail vs query_api）
  - 搜索失败重试（3层重试）
  - 人性化写作规则
  - 发布前自检（5项硬性检查）

#### 2.2 关键词提取优化（processor.js）
**优化方法**: `extractSearchQuery(title, content)`

**改进点**:
- 拆原子：复杂问题→独立技术点
- 去噪音：删除无效词（怎么/如何/实现等）
- 英文优先：API名称比中文描述更精准
- 不加Laya前缀：查Camera而非Laya.Camera
- 限制关键词数量≤4个

**示例**:
```
优化前: "如何动态创建 Sprite3D？" → "如何动态创建 Sprite3D"
优化后: "如何动态创建 Sprite3D？" → "Sprite3D"
```

#### 2.3 预过滤机制（processor.js）
**新增方法**: `shouldSkipReply(discussion)`

**过滤规则**:
- 帖子内容<20字且无代码 → 跳过
- 纯吐槽/灌水（关键词检测）→ 跳过
- 招聘/求职帖 → 跳过

#### 2.4 搜索失败重试机制（processor.js）
**更新方法**: `processDiscussion(discussionId)`

**3层重试策略**:
```
尝试1: 使用原始关键词（如 "Sprite3D MeshFilter"）
  ↓ 失败
尝试2: 缩短为前2个词（如 "Sprite3D"）
  ↓ 失败
尝试3: 只用第1个词（如 "Sprite3D"）
  ↓ 失败
使用通用框架回复（不含具体API）
```

### 3. Tag功能支持 ✅
**修改文件**: `db.js`, `processor.js`, `ai-service.js`

**功能**:
- 数据库查询时获取讨论的tags
- 在AI prompt中包含tags信息
- AI可根据标签（LayaAir3/LayaAir2）提供更准确的回复

### 4. 数据库写入重试机制 ✅
**修改文件**: `processor.js`

**功能**:
- 解决webhook触发太快导致数据库未完成写入的问题
- 最多重试5次，每次间隔1秒
- 等待first_post_id等字段写入完成

### 5. 超时配置优化 ✅
**修改文件**: `ai-service.js`, `mcp-client.js`

**优化**:
- AI生成超时：60秒 → 180秒
- MCP连接超时：30秒 → 120秒
- 适配慢响应API（如GLM-4.7）

### 6. FoF Webhooks扩展问题修复 ✅
**问题**: TypeError: in_array() 参数类型错误
**解决**: 完全删除fof/webhooks扩展
```bash
composer remove fof/webhooks
composer dump-autoload
php flarum cache:clear
```

---

## 技术改进对比

| 项目 | 优化前 | 优化后 | 提升 |
|------|--------|--------|------|
| **关键词提取** | 简单API名提取 | 拆原子+去噪音+英文 | ⭐⭐⭐⭐⭐ |
| **MCP搜索质量** | 经常无结果 | 3层重试机制 | ⭐⭐⭐⭐ |
| **预过滤** | 无 | 4类帖子自动过滤 | ⭐⭐⭐⭐ |
| **回复风格** | 技术化 | 人性化、有温度 | ⭐⭐⭐⭐⭐ |
| **链接管理** | 有入口检查 | 严格禁止拼接 | ⭐⭐⭐⭐⭐ |
| **Tag支持** | 无 | 完整支持 | ⭐⭐⭐ |
| **数据库写入** | 可能失败 | 5次重试机制 | ⭐⭐⭐⭐ |

---

## 修复的问题

### 1. AI回复被截断
**原因**: 新webhook中断了正在处理的请求
**解决**: 添加队列机制，防止并发处理

### 2. MCP知识库搜索无结果
**原因**: 搜索词太复杂，包含HTML标签
**解决**:
- 智能关键词提取
- 去除HTML标签
- 英文优先
- 3层重试机制

### 3. FoF Webhooks TypeError
**原因**: 扩展不兼容
**解决**: 完全删除fof/webhooks，使用laya-webhooks

### 4. 讨论不存在错误
**原因**: Webhook触发太快，数据库未完成写入
**解决**: 添加重试机制，等待数据写入完成

### 5. AI生成超时
**原因**: GLM-4.7响应慢（>60秒）
**解决**: 增加超时时间到180秒

---

## 文件修改清单

### 核心文件（已提交）
- `ai-service/ai-service.js` - 系统提示词v4.0、Tag支持
- `ai-service/processor.js` - 关键词优化、预过滤、重试机制
- `ai-service/db.js` - Tag查询支持
- `ai-service/mcp-client.js` - 超时配置优化
- `ai-service/server.js` - 队列机制

### 文档（已提交）
- `AUTO_REPLY_SYSTEM_DOC.md` - 完整技术文档
- `UPGRADE_v4.0.md` - v4.0升级说明

---

## 配置参数汇总

### 当前AI配置
- **模型**: glm-4.7
- **超时**: 180秒
- **温度**: 0.7
- **最大token**: 2000

### MCP配置
- **URL**: https://laya-knowledge-mcp.layaair.com/mcp
- **超时**: 120秒
- **版本**: v3.3.5

### 数据库配置
- **Host**: localhost
- **Database**: flarum
- **AI用户ID**: 4

---

## 服务器状态

- **运行状态**: ✅ 正常
- **PID**: 2026138
- **端口**: 3000
- **启动时间**: 2026-02-27 11:53:56
- **Webhook**: http://43.128.56.125:3000/webhooks

---

## 测试建议

### 高优先级测试
1. **基础API问题**: "如何动态创建 Sprite3D？"
   - 预期：关键词="Sprite3D"，有代码示例

2. **复杂问题**: "3D场景角色头顶血条UI怎么做"
   - 预期：进入重试流程，拆解为多技术点

3. **预过滤**: "这个引擎太坑了"
   - 预期：识别为吐槽，跳过不回复

4. **Tag功能**: 发帖时选择"LayaAir3"标签
   - 预期：AI知道是3.x问题

### 监控指标
- AI响应时间（正常<90秒）
- MCP搜索成功率
- 预过滤准确率
- 回复质量（代码示例、链接准确性）

---

## 已知限制

1. **GLM-4.7响应慢**: 平均90秒，已设置180秒超时
2. **MCP搜索偶尔无结果**: 已实现3层重试
3. **AI回复可能简短**: 无MCP结果时使用通用框架

---

## 下一步优化建议

1. **性能优化**
   - 考虑使用更快的AI模型（GLM-4-Flash）
   - 添加Redis缓存MCP搜索结果

2. **功能增强**
   - 支持图片识别（报错截图）
   - 支持代码片段高亮
   - 添加回复质量评分

3. **监控完善**
   - 添加Prometheus监控
   - 配置告警规则
   - 定期生成统计报告

---

## 工作统计

- **代码修改**: 5个核心文件
- **新增功能**: 6项（v4.0规范、Tag支持、预过滤、重试、超时优化、队列）
- **问题修复**: 5个（截断、搜索无结果、TypeError、数据库、超时）
- **文档输出**: 2份（技术文档9KB、升级说明2.3KB）
- **测试脚本**: 20+ 个（用于调试和验证）

---

**状态**: ✅ 已完成并提交
**准备测试**: ✅ 系统正常运行，等待用户测试反馈
