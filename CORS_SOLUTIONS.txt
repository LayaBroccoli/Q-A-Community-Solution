ğŸ”§ **ç»•è¿‡CORS - æœ€ç»ˆè§£å†³æ–¹æ¡ˆ**

å¦‚æœAPIè·¨åŸŸæœ‰é—®é¢˜ï¼Œä½¿ç”¨è¿™ä¸ªç»•è¿‡æ–¹æ³•ï¼š

=======================================
æ–¹æ³•ï¼šé€šè¿‡æœåŠ¡å™¨ä»£ç†ï¼ˆæ¨èï¼‰
=======================================

åœ¨ ai-service/server.js ä¸­æ·»åŠ ä»£ç†ç«¯ç‚¹ï¼š

```javascript
// æ·»åŠ åˆ° server.js çš„ webhook ç«¯ç‚¹ä¹‹å

// Flarumè¯„åˆ†ä»£ç†ï¼ˆç»•è¿‡CORSï¼‰
app.post('/proxy-rating', async (req, res) => {
  try {
    const { post_id, discussion_id, rating, user_id } = req.body;

    // ç›´æ¥è°ƒç”¨è¯„åˆ†æœåŠ¡
    const RatingService = require('./rating-service');
    const service = new RatingService(db);

    // æ¨¡æ‹Ÿè¯·æ±‚å¯¹è±¡
    const mockReq = {
      body: { post_id, discussion_id, rating, user_id },
      ip: req.ip
    };

    // æ¨¡æ‹Ÿå“åº”å¯¹è±¡
    let responseData = null;
    const mockRes = {
      json: (data) => { responseData = data; },
      status: (code) => ({ json: (data) => { responseData = data; } })
    };

    await service.submitRating(mockReq, mockRes);

    if (responseData && responseData.success) {
      res.json({ success: true, message: responseData.message });
    } else {
      res.status(400).json(responseData || { success: false, error: 'æœªçŸ¥é”™è¯¯' });
    }
  } catch (error) {
    console.error('ä»£ç†é”™è¯¯:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});

app.get('/proxy-rating/:post_id', async (req, res) => {
  try {
    const { post_id } = req.params;

    const result = await db.query(
      'SELECT * FROM ai_rating_stats WHERE post_id = ?',
      [post_id]
    );

    if (result.length > 0) {
      res.json({ success: true, data: result[0] });
    } else {
      res.json({
        success: true,
        data: {
          post_id: parseInt(post_id),
          total_ratings: 0,
          helpful_count: 0,
          partial_count: 0,
          not_helpful_count: 0,
          irrelevant_count: 0,
          average_score: 0
        }
      });
    }
  } catch (error) {
    console.error('æŸ¥è¯¢é”™è¯¯:', error);
    res.status(500).json({ success: false, error: error.message });
  }
});
```

ç„¶åä¿®æ”¹Flarumä¸­çš„APIåœ°å€ä¸ºï¼š
```javascript
apiBaseUrl: window.location.origin + '/proxy-rating'
```

=======================================
æ–¹æ³•ï¼šä½¿ç”¨JSONPï¼ˆå¤‡é€‰ï¼‰
=======================================

å¦‚æœä¸Šé¢ä¸è¡Œï¼Œåœ¨ server.js æ·»åŠ ï¼š

```javascript
app.get('/api/ratings-jsonp', (req, res) => {
  const post_id = req.query.post_id;

  db.query('SELECT * FROM ai_rating_stats WHERE post_id = ?', [post_id])
    .then(results => {
      const data = results.length > 0 ? results[0] : { post_id, total_ratings: 0 };
      res.jsonp(req.query.callback, { success: true, data });
    });
});
```

=======================================
æ–¹æ³•ï¼šç›´æ¥æ•°æ®åº“æŸ¥è¯¢ï¼ˆæœ€ç®€å•ï¼‰
=======================================

å®Œå…¨ç»•è¿‡APIï¼Œç›´æ¥åœ¨Flarumä¸­åˆ›å»ºä¸€ä¸ªéšè—çš„iframeæäº¤è¡¨å•ï¼š

```javascript
// åœ¨Flarumä¸­
function submitRating(postId, rating) {
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = 'http://43.128.56.125:3000/rate';  // æ–°å»ºä¸€ä¸ªç®€å•ç«¯ç‚¹
  form.style.display = 'none';

  form.innerHTML = `
    <input name="post_id" value="${postId}">
    <input name="rating" value="${rating}">
    <input name="user_id" value="${app?.session?.user?.id || ''}">
  `;

  document.body.appendChild(form);
  form.submit();
}
```

ç„¶ååœ¨server.jsæ·»åŠ ï¼š
```javascript
app.post('/rate', express.urlencoded(), async (req, res) => {
  // ç›´æ¥å¤„ç†è¯„åˆ†
  // é‡å®šå‘å›è®ºå›
  res.redirect('back');
});
```

---

**å“ªä¸ªæ–¹æ³•æ›´é€‚åˆï¼Ÿæˆ‘æ¨èæ–¹æ³•1ï¼ˆä»£ç†ï¼‰ï¼**
